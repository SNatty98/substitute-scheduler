---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Login">
  <main class="container">
    <div class="login-card">
      <h1>Login</h1>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required />
        </div>

        <div id="error" class="error"></div>

        <button type="submit" class="btn-primary">Login</button>
      </form>
    </div>
  </main>
</BaseLayout>

<script>
  import { authService } from "../services/authService";

  const form = document.getElementById("loginForm") as HTMLFormElement;
  const errorDiv = document.getElementById("error") as HTMLDivElement;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorDiv.textContent = "";

    const formData = new FormData(form);
    const username = formData.get("username") as string;
    const password = formData.get("password") as string;

    try {
      await authService.login(username, password);

      // Get user to determine role
      const user = await authService.getCurrentUser();

      // Redirect based on role
      if (user.role === "admin") {
        window.location.href = "/admin/dashboard";
      } else {
        window.location.href = "/substitute/dashboard";
      }
    } catch (error: any) {
      errorDiv.textContent =
        error.response?.data?.detail ||
        "Login failed. Please check your credentials.";
    }
  });
</script>
